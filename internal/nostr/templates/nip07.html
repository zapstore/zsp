<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>zsp - NIP-07 Signer</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a1e;
      color: #e0e0e4;
      min-height: 100vh;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 32px 24px;
    }
    
    .header-banner {
      padding: 16px 0;
      margin-bottom: 24px;
    }
    
    .header-banner h1 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #9080a0;
    }
    
    .subtitle {
      color: #8a8a94;
      margin-top: 8px;
      font-size: 1rem;
    }
    
    .section {
      background: #232328;
      border: 1px solid #3a3a42;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .section h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #9080a0;
      border-bottom: 1px solid #3a3a42;
      padding-bottom: 12px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section h2::before {
      content: '';
      display: block;
      width: 4px;
      height: 18px;
      background: #4a3a5c;
      border-radius: 2px;
    }
    
    .status {
      padding: 16px;
      border-radius: 6px;
      margin-bottom: 16px;
      background: #1a1a1e;
      border: 1px solid #3a3a42;
      color: #c8c8d0;
    }
    
    .status.waiting {
      background: rgba(74, 58, 92, 0.15);
      border-color: #3a3a42;
    }
    
    .status.success {
      background: rgba(74, 58, 92, 0.3);
      border-color: #4a3a5c;
      color: #9080a0;
    }
    
    .status.error {
      background: rgba(140, 50, 50, 0.2);
      border-color: #8c3232;
      color: #e0a0a0;
    }
    
    pre {
      background: #1a1a1e;
      padding: 16px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
      border: 1px solid #3a3a42;
      font-family: 'SF Mono', 'Menlo', 'Monaco', monospace;
    }
    
    button {
      background: #4a3a5c;
      color: #e0e0e4;
      border: 1px solid #5a4a6c;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    button:hover {
      background: #5a4a6c;
      border-color: #6a5a7c;
    }
    
    button:disabled {
      background: #2a2a30;
      border-color: #3a3a42;
      color: #6a6a74;
      cursor: not-allowed;
    }
    
    .event {
      background: #1a1a1e;
      border: 1px solid #3a3a42;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 12px;
    }
    
    .event.signed {
      border-color: #4a3a5c;
      box-shadow: 0 0 8px rgba(74, 58, 92, 0.4);
    }
    
    .json-key { color: #9080a0; font-weight: 500; }
    .json-string { color: #a8c8a8; }
    .json-number { color: #c9a866; }
    
    #idle-section, #publicKey-section, #sign-section { display: none; }
    
    .hint {
      margin-top: 12px;
      color: #8a8a94;
      font-size: 0.9rem;
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #3a3a42;
      border-top-color: #9080a0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-banner">
      <h1>Zapstore Publisher - NIP-07 Signer</h1>
      <p class="subtitle">Sign Nostr events with your browser extension</p>
    </div>

    <div id="idle-section" class="section">
      <h2>Status</h2>
      <div class="status waiting"><span class="spinner"></span>Waiting for operation from terminal...</div>
    </div>

    <div id="publicKey-section" class="section">
      <h2>Public Key</h2>
      <div id="pk-status" class="status waiting"><span class="spinner"></span>Requesting public key from extension...</div>
    </div>

    <div id="sign-section" class="section">
      <h2>Sign Events</h2>
      <div id="sign-status" class="status waiting">Ready to sign events</div>
      <div style="margin-top: 16px;">
        <button id="sign-all">Sign All Events</button>
      </div>
      <p class="hint">This tab will close automatically after signing.</p>
      <div id="events-container" style="margin-top: 20px;"></div>
    </div>
  </div>

  <script type="module">
    function highlightJSON(json) {
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        let cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
          } else {
            cls = 'json-string';
          }
        }
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }

    const idleSection = document.getElementById('idle-section');
    const publicKeySection = document.getElementById('publicKey-section');
    const signSection = document.getElementById('sign-section');

    // Wait for extension injection
    await new Promise(r => setTimeout(r, 100));

    async function waitForNostr(timeout = 4000) {
      const start = Date.now();
      while (Date.now() - start < timeout) {
        if (window.nostr) return true;
        await new Promise(r => setTimeout(r, 100));
      }
      return !!window.nostr;
    }

    const hasNostr = await waitForNostr();
    if (!hasNostr) {
      document.querySelector('.container').innerHTML = '<div class="section"><h2>Error</h2><div class="status error"><strong>No Nostr extension detected</strong><br><br>Please install a NIP-07 compatible browser extension (e.g., Alby, nos2x, Flamingo).</div></div>';
    } else {
      let displayedSignature = null;

      async function checkState() {
        try {
          const resp = await fetch('/api/state');
          const state = await resp.json();

          idleSection.style.display = state.mode === 'idle' ? 'block' : 'none';
          publicKeySection.style.display = state.mode === 'publicKey' ? 'block' : 'none';
          signSection.style.display = state.mode === 'sign' ? 'block' : 'none';

          if (state.mode === 'publicKey') {
            handlePublicKey();
          }
          if (state.mode === 'sign') {
            handleSigning(state.data);
          }
        } catch (e) {
          console.error('State check error:', e);
        }
      }

      async function handlePublicKey() {
        const status = document.getElementById('pk-status');
        try {
          const pubkey = await window.nostr.getPublicKey();
          status.className = 'status success';
          status.innerHTML = '✓ Public key retrieved: ' + pubkey.slice(0, 16) + '...';

          await fetch('/public-key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ publicKey: pubkey })
          });
        } catch (e) {
          status.className = 'status error';
          status.textContent = 'Error: ' + e.message;
        }
      }

      async function handleSigning(events) {
        const sig = JSON.stringify(events || []);
        if (sig === displayedSignature) return;
        displayedSignature = sig;

        const status = document.getElementById('sign-status');
        const container = document.getElementById('events-container');
        const btn = document.getElementById('sign-all');

        container.innerHTML = '';
        if (!events || events.length === 0) {
          status.textContent = 'No events to sign.';
          btn.style.display = 'none';
          return;
        }

        btn.style.display = 'inline-block';
        btn.disabled = false;

        const kindCounts = events.reduce((acc, e) => {
          acc[e.kind] = (acc[e.kind] || 0) + 1;
          return acc;
        }, {});
        const breakdown = Object.entries(kindCounts).map(([k, c]) => 'kind ' + k + ' (' + c + ')').join(', ');
        status.textContent = 'Ready to sign: ' + breakdown;

        events.forEach((event, i) => {
          const div = document.createElement('div');
          div.className = 'event';
          div.id = 'event-' + i;
          const pre = document.createElement('pre');
          pre.innerHTML = highlightJSON(JSON.stringify(event, null, 2));
          div.appendChild(pre);
          container.appendChild(div);
        });

        btn.onclick = async () => {
          btn.disabled = true;
          status.innerHTML = '<span class="spinner"></span>Signing events...';

          try {
            const signed = [];
            for (let i = 0; i < events.length; i++) {
              status.innerHTML = '<span class="spinner"></span>Signing event ' + (i + 1) + ' of ' + events.length + '...';
              const ev = { ...events[i] };
              delete ev.id;
              delete ev.pubkey;
              delete ev.sig;
              const signedEv = await window.nostr.signEvent(ev);
              signed.push(signedEv);

              const div = document.getElementById('event-' + i);
              div.className = 'event signed';
              div.querySelector('pre').innerHTML = highlightJSON(JSON.stringify(signedEv, null, 2));
            }

            status.className = 'status success';
            status.innerHTML = '✓ All events signed! Sending to terminal...';

            const resp = await fetch('/signed-events', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(signed)
            });

            if (resp.ok) {
              status.innerHTML = '✓ Success! Events signed and sent. Closing...';
              setTimeout(() => window.close(), 300);
            }
          } catch (e) {
            status.className = 'status error';
            status.textContent = 'Error: ' + e.message;
            btn.disabled = false;
          }
        };
      }

      async function checkShutdown() {
        try {
          const resp = await fetch('/api/shutdown');
          const data = await resp.json();
          if (data.shouldClose) {
            document.querySelector('.container').innerHTML = '<div class="section"><h2>Complete</h2><div class="status success"><strong>✓ Done</strong><br><br>All events signed. Closing...</div></div>';
            setTimeout(() => window.close(), 300);
          }
        } catch (e) {
          // Server closed (Ctrl+C in terminal)
          window.close();
        }
      }

      checkState();
      setInterval(checkState, 1000);
      setInterval(checkShutdown, 1000);
    }
  </script>
</body>
</html>
